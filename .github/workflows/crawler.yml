name: åœ°ä¸‹å‚ä¿¡æ¯æ¯æ—¥é‡‡é›†

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTC 0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  actions: read
  checks: read

jobs:
  crawl:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        pip install requests beautifulsoup4
    
    - name: è¿è¡Œçˆ¬è™«
      run: |
        python underground_wastewater_crawler.py
        echo "çˆ¬è™«è¿è¡Œå®Œæˆæ—¶é—´: $(date)" >> run_log.txt
        echo "æŠ“å–æ•°æ®æ¡æ•°: $(jq length underground_wastewater_data.json)" >> run_log.txt
    
    # ===== é£ä¹¦è‡ªåŠ¨æ¨é€ï¼ˆæ–°å¢ï¼‰ =====
    - name: æ¨é€åˆ°é£ä¹¦å¤šç»´è¡¨æ ¼
      env:
        FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
        FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
        FEISHU_BASE_ID: ${{ secrets.FEISHU_BASE_ID }}
        FEISHU_TABLE_ID: ${{ secrets.FEISHU_TABLE_ID }}
      run: |
        echo "å¼€å§‹æ¨é€åˆ°é£ä¹¦..."
        python feishu_uploader.py underground_wastewater_data.json
        echo "é£ä¹¦æ¨é€å®Œæˆ"
    
    - name: é…ç½®Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: æäº¤æ•°æ®åˆ°ä»“åº“
      run: |
        git add -A
        git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°åœ°ä¸‹å‚æ•°æ® $(date +'%Y-%m-%d %H:%M')" || echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
        git push
    
    - name: ä¸Šä¼ æ•°æ®æ–‡ä»¶ï¼ˆå¤‡ä»½ï¼‰
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: wastewater-data-${{ github.run_id }}
        path: |
          underground_wastewater_data.json
          underground_wastewater_data.csv
          run_log.txt
        retention-days: 30
