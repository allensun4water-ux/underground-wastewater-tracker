# .github/workflows/bot_command.yml
name: é£ä¹¦æœºå™¨äººå¤„ç†

on:
  workflow_dispatch:
    inputs:
      message:
        description: 'ç”¨æˆ·å‘é€çš„æ¶ˆæ¯ï¼ˆåŒ…å«é“¾æ¥ï¼‰'
        required: true
        default: ''

jobs:
  process:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: å®‰è£…ä¾èµ–
      run: pip install requests beautifulsoup4
    
    - name: å¤„ç†æ¶ˆæ¯
      env:
        # é£ä¹¦æœºå™¨äºº
        FEISHU_BOT_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        # é£ä¹¦åº”ç”¨
        FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
        FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
        # ä¸»è¡¨ï¼ˆé¡¹ç›®è¡¨ï¼‰
        FEISHU_BASE_ID: ${{ secrets.FEISHU_BASE_ID }}
        FEISHU_TABLE_ID: ${{ secrets.FEISHU_TABLE_ID }}
        # æ˜ç»†è¡¨ï¼ˆå¯ä»¥ç›¸åŒbaseï¼Œä¸åŒtableï¼‰
        FEISHU_DETAIL_BASE_ID: ${{ secrets.FEISHU_BASE_ID }}
        FEISHU_DETAIL_TABLE_ID: ${{ secrets.FEISHU_DETAIL_TABLE_ID }}
        # Kimi API
        KIMI_API_KEY: ${{ secrets.KIMI_API_KEY }}
      run: |
        python bot_handler.py "${{ github.event.inputs.message }}"
    
    - name: æäº¤ç½‘é¡µå­˜æ¡£åˆ°ä»“åº“
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # 1. å…ˆæš‚å­˜å½“å‰å˜æ›´ï¼ˆå¦‚æœæœ‰ï¼‰
        git stash push -m "temp-changes" || true
        
        # 2. æ‹‰å–è¿œç¨‹æœ€æ–°
        git pull origin main --rebase || true
        
        # 3. æ¢å¤æš‚å­˜
        git stash pop || true
        
        # 4. é‡æ–°æ·»åŠ å­˜æ¡£æ–‡ä»¶ï¼ˆé¿å…å†²çªè¦†ç›–ï¼‰
        git add web_archives/
        
        # 5. æäº¤å¹¶æ¨é€
        git commit -m "ğŸ“¦ ç½‘é¡µå­˜æ¡£ $(date +'%Y-%m-%d %H:%M')" || echo "æ— æ–°å­˜æ¡£"
        git push origin main || echo "æ¨é€å¤±è´¥"

        # git pull origin main --rebase || true  # å…ˆæ‹‰å–æ›´æ–°
        # git add web_archives/ || true
        git commit -m "ğŸ“¦ ç½‘é¡µå­˜æ¡£ $(date +'%Y-%m-%d %H:%M')" || echo "æ— æ–°å­˜æ¡£"
        git push || echo "æ¨é€å¤±è´¥ï¼Œä¸‹æ¬¡å†è¯•"
